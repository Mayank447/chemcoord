import itertools
import os
import sys

import chemcoord as cc
import numpy as np
import pandas as pd
import pytest
from chemcoord.exceptions import UndefinedCoordinateSystem
from chemcoord.xyz_functions import allclose


def get_script_path():
    return os.path.dirname(os.path.realpath(__file__))


def get_structure_path(script_path):
    test_path = os.path.join(script_path)
    while True:
        structure_path = os.path.join(test_path, 'structures')
        if os.path.exists(structure_path):
            return structure_path
        else:
            test_path = os.path.join(test_path, '..')


STRUCTURE_PATH = get_structure_path(get_script_path())


def test_grad_cartesian_properties():
    path = os.path.join(STRUCTURE_PATH, 'MIL53_beta.xyz')
    molecule = cc.Cartesian.read_xyz(path, start_index=1)
    fragment = molecule.get_fragment([(12, 17), (55, 60)])
    connection = np.array([[3, 99, 1, 12], [17, 3, 99, 12], [60, 3, 17, 12]])
    connection = pd.DataFrame(connection[:, 1:], index=connection[:, 0],
                              columns=['b', 'a', 'd'])
    c_table = molecule.get_construction_table([(fragment, connection)])
    zmolecule = molecule.get_zmat(c_table)

    r = 0.3
    zmolecule2 = zmolecule.copy()
    zmolecule2.safe_loc[3, 'bond'] += r

    dist_zmol = zmolecule.copy()
    dist_zmol.unsafe_loc[:, ['bond', 'angle', 'dihedral']] = 0
    dist_zmol.unsafe_loc[3, 'bond'] = r

    new = zmolecule.get_grad_cartesian(chain=False)(
            dist_zmol).loc[:, ['x', 'y', 'z']]
    index = new.index[~np.isclose(new, 0.).all(axis=1)]
    assert (index == [3]).all()

    new = zmolecule.get_grad_cartesian()(dist_zmol).loc[:, ['x', 'y', 'z']]
    index = new.index[~np.isclose(new, 0.).all(axis=1)]
    assert (index
            == [3, 17, 60, 6, 19, 62, 38, 37, 81, 80, 7, 39, 82, 10]).all()


def test_grad_cartesian():
    path = os.path.join(STRUCTURE_PATH, 'cis_platin.xyz')
    m = cc.Cartesian.read_xyz(path, start_index=1)

    print(m)

    zm1 = m.get_zmat()
    c_table_1 = zm1.loc[:, ['b', 'a', 'd']]
    c_table_1.loc[[10, 11], 'd'] = 9
    c_table_1.loc[[6, 7], 'd'] = 5
    zm1 = m.get_zmat(c_table_1)

    print(zm1)

    expected1 = np.array([[[[0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [1.2246467991473532e-16, -2.05, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [0.0, -1.2552629691260368e-16, 0.0],
                           [-1.0, -1.2552629691260368e-16, 2.5105259382520737e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [0.0, 2.32, 0.0],
                           [0.0, 0.0, 0.0],
                           [-1.2246467991473532e-16, 2.32, 3.479442695775509e-32],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[-2.062449987798341e-16, 0.0, 0.0],
                           [0.0, -1.4205902870109293e-16, 0.0],
                           [0.0, 0.0, -5.682361148043718e-16],
                           [0.0, 0.0, 0.0],
                           [1.0, 1.4205902870109295e-16, -5.682361148043718e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[-5.144503788329211e-33, 0.0, 0.0],
                           [1.419046634655322e-16, -2.05, 0.0],
                           [0.0, 0.0, 0.9450769999999998],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [5.789631688971223e-17, -1.992598313956677e-17, -0.9450769999999998],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [2.1045947996332006e-16, -2.05, 7.27728696881949e-33],
                           [0.0, 0.0, -0.4473950000000001],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.4473950000000001],
                           [0.8234366374014372, -0.30616442225848084, 0.4473950000000001],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [2.154378076431763e-16, -2.05, 7.527163883883366e-33],
                           [0.0, 0.0, -0.4627569999999997],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.4627569999999997],
                           [0.0, 0.0, 0.0],
                           [-0.7942709783949574, 0.33970163463607644, 0.4627569999999997],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[-3.79489069704663e-17, 0.0, 0.0],
                           [0.0, -1.2552629691260368e-16, 7.0869423805936e-33],
                           [-1.0, -1.2552629691260368e-16, 2.5105259382520737e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [-0.32556805805179784, -0.9450769999999998, 5.786927614988916e-17],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.40145707317073165, 0.0, 0.0],
                           [0.0, -1.2552629691260368e-16, -1.5697753182355353e-32],
                           [-1.0, -1.2552629691260368e-16, 2.5105259382520737e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, -1.281818822642148e-16],
                           [-0.3486703913933672, -0.9367336271288653, -1.281818822642148e-16],
                           [0.0, 0.0, 0.0]],
                          [[-0.38724926829268297, 0.0, 0.0],
                           [0.0, -1.2552629691260368e-16, 8.435886319510988e-33],
                           [-1.0, -1.2552629691260368e-16, 2.5105259382520737e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 6.888423932014015e-17],
                           [0.0, 0.0, 0.0],
                           [-0.3934060641823097, -0.9188902700377233, 6.888423932014015e-17]]],
                         [[[0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [0.0, 0.0, 2.5105259382520737e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [1.2246467991473532e-16, 1.5372537772284038e-32, 2.05],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [1.4997597826618573e-32, -2.8411805740218586e-16, 2.841180574021859e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[7.29953995049337e-32, 0.0, 0.0],
                           [0.0, -1.7397213478877533e-32, 0.0],
                           [0.0, 0.0, -2.32],
                           [0.0, 0.0, 0.0],
                           [-2.449293598294706e-16, -3.479442695775509e-32, -2.32],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[9.047617490669021e-17, 0.0, 0.0],
                           [-9.047617490669021e-17, 0.0, 2.5105259382520737e-16],
                           [0.0, 0.0, -5.786927614988912e-17],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.9455186087943385, -0.32541600000000037, 5.786927614988912e-17],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [1.2357267531799838e-16, 0.0, 2.5105259382520737e-16],
                           [0.0, 0.0, -0.822987],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.822987],
                           [-0.4476394334178014, 0.1664381474996969, 0.822987],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [-1.191993647537829e-16, 0.0, 2.510525938252073e-16],
                           [0.0, 0.0, 0.7938610000000001],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, -0.7938610000000001],
                           [0.0, 0.0, 0.0],
                           [-0.4629959843714644, 0.1980186825392439, -0.7938610000000001],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[4.647400745252224e-33, 0.0, 0.0],
                           [0.0, 0.0, 7.0869423805936e-33],
                           [2.1294085482142554e-16, 1.5372537772284038e-32, 2.05],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [-0.9455186087943385, 0.3254160000000005, 5.786927614988914e-17],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[-1.0090474690664646, 0.0, 0.0],
                           [0.0, 0.0, -1.007868395289883e-16],
                           [7.172396504342279e-17, 1.5372537772284038e-32, 2.05],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, -0.822987],
                           [0.4476394334178013, -0.16643814749969674, -0.822987],
                           [0.0, 0.0, 0.0]],
                          [[0.9733366782714342, 0.0, 0.0],
                           [0.0, 0.0, 9.721993326179174e-17],
                           [6.998170403949316e-17, 1.5372537772284038e-32, 2.05],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.7938610000000001],
                           [0.0, 0.0, 0.0],
                           [0.46299598437146455, -0.19801868253924385, 0.7938610000000001]]],
                         [[[1.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.0, 0.0, 0.0],
                           [-1.0, -2.5105259382520737e-16, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.0, 0.0, 0.0],
                           [0.0, 2.05, 0.0],
                           [-6.123233995736766e-17, 2.05, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [1.0, 2.841180574021859e-16, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.0, 0.0, 0.0],
                           [0.0, -2.3199999999999994, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [-6.123233995736766e-17, 2.32, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.0, 0.0, 0.0],
                           [-1.0, -2.5105259382520737e-16, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [-0.3255680580517977, -0.9450769999999998, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.0, 0.0, 0.0],
                           [-1.0, -2.5105259382520737e-16, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [-0.3486703913933672, -0.9367336271288653, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.0, 0.0, 0.0],
                           [-1.0, -2.5105259382520737e-16, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [-0.39340606418230983, -0.9188902700377233, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.158739512195122, 0.0, 0.0],
                           [0.0, 2.05, -1.157385522997783e-16],
                           [-6.123233995736766e-17, 2.05, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [-7.783161089959995e-17, -3.794329301032237e-17, -0.9450769999999998],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.7185320707150025, 0.0, 0.0],
                           [0.0, 2.05, 5.479008547045302e-17],
                           [-6.123233995736767e-17, 2.05, 5.942355766484037e-17],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.447395],
                           [0.8234366374014372, -0.3061644222584809, 0.447395],
                           [0.0, 0.0, 0.0]],
                          [[1.7591832011741875, 0.0, 0.0],
                           [0.0, 2.05, 5.667138788330315e-17],
                           [-6.123233995736762e-17, 2.05, 6.14639575192135e-17],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.4627569999999998],
                           [0.0, 0.0, 0.0],
                           [-0.7942709783949574, 0.3397016346360764, 0.4627569999999998]]]])


    assert np.allclose(zm1.get_grad_cartesian(as_function=False), expected1)

    c_table_2 = zm1.loc[:, ['b', 'a', 'd']]
    c_table_2.loc[2, ['a', 'd']] = [4, 8]
    zm2 = m.get_zmat(c_table_2)

    expected2 = np.array(
                        [[[[0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [1.2246467991473532e-16, -2.05, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [0.0, -1.2552629691260368e-16, 0.0],
                           [-1.0, -1.2552629691260368e-16, 2.5105259382520737e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[-1.1317073170731708, 0.0, 0.0],
                           [0.0, 2.3199999999999994, -3.4794426957755093e-32],
                           [0.0, 2.3199999999999994, 0.0],
                           [-1.224646799147353e-16, 2.32, 2.841180574021859e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[-2.062449987798341e-16, 0.0, 0.0],
                           [0.0, -1.4205902870109293e-16, 0.0],
                           [0.0, 0.0, -5.682361148043718e-16],
                           [0.0, 0.0, 0.0],
                           [1.0, 1.4205902870109295e-16, -5.682361148043718e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[-5.144503788329211e-33, 0.0, 0.0],
                           [1.419046634655322e-16, -2.05, 0.0],
                           [0.0, 0.0, 0.9450769999999998],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [5.789631688971223e-17, -1.992598313956677e-17, -0.9450769999999998],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [2.1045947996332006e-16, -2.05, 7.27728696881949e-33],
                           [0.0, 0.0, -0.4473950000000001],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.4473950000000001],
                           [0.8234366374014372, -0.30616442225848084, 0.4473950000000001],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [2.154378076431763e-16, -2.05, 7.527163883883366e-33],
                           [0.0, 0.0, -0.4627569999999997],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.4627569999999997],
                           [0.0, 0.0, 0.0],
                           [-0.7942709783949574, 0.33970163463607644, 0.4627569999999997],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[-3.79489069704663e-17, 0.0, 0.0],
                           [0.0, -1.2552629691260368e-16, 7.0869423805936e-33],
                           [-1.0, -1.2552629691260368e-16, 2.5105259382520737e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [-0.32556805805179784, -0.9450769999999998, 5.786927614988916e-17],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.40145707317073165, 0.0, 0.0],
                           [0.0, -1.2552629691260368e-16, -1.5697753182355353e-32],
                           [-1.0, -1.2552629691260368e-16, 2.5105259382520737e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, -1.281818822642148e-16],
                           [-0.3486703913933672, -0.9367336271288653, -1.281818822642148e-16],
                           [0.0, 0.0, 0.0]],
                          [[-0.38724926829268297, 0.0, 0.0],
                           [0.0, -1.2552629691260368e-16, 8.435886319510988e-33],
                           [-1.0, -1.2552629691260368e-16, 2.5105259382520737e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 6.888423932014015e-17],
                           [0.0, 0.0, 0.0],
                           [-0.3934060641823097, -0.9188902700377233, 6.888423932014015e-17]]],
                         [[[0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [0.0, 0.0, 2.5105259382520737e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [1.2246467991473532e-16, 1.5372537772284038e-32, 2.05],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.3859417434252968e-16, 0.0, 0.0],
                           [0.0, -2.8411805740218586e-16, -2.841180574021859e-16],
                           [0.0, -2.8411805740218586e-16, 0.0],
                           [1.2246467991473532e-16, -2.841180574021859e-16, 2.32],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[7.29953995049337e-32, 0.0, 0.0],
                           [0.0, -1.7397213478877533e-32, 0.0],
                           [0.0, 0.0, -2.32],
                           [0.0, 0.0, 0.0],
                           [-2.449293598294706e-16, -3.479442695775509e-32, -2.32],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[9.047617490669021e-17, 0.0, 0.0],
                           [-9.047617490669021e-17, 0.0, 2.5105259382520737e-16],
                           [0.0, 0.0, -5.786927614988912e-17],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.9455186087943385, -0.32541600000000037, 5.786927614988912e-17],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [1.2357267531799838e-16, 0.0, 2.5105259382520737e-16],
                           [0.0, 0.0, -0.822987],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.822987],
                           [-0.4476394334178014, 0.1664381474996969, 0.822987],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.0, 0.0, 0.0],
                           [-1.191993647537829e-16, 0.0, 2.510525938252073e-16],
                           [0.0, 0.0, 0.7938610000000001],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, -0.7938610000000001],
                           [0.0, 0.0, 0.0],
                           [-0.4629959843714644, 0.1980186825392439, -0.7938610000000001],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[4.647400745252224e-33, 0.0, 0.0],
                           [0.0, 0.0, 7.0869423805936e-33],
                           [2.1294085482142554e-16, 1.5372537772284038e-32, 2.05],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [-0.9455186087943385, 0.3254160000000005, 5.786927614988914e-17],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[-1.0090474690664646, 0.0, 0.0],
                           [0.0, 0.0, -1.007868395289883e-16],
                           [7.172396504342279e-17, 1.5372537772284038e-32, 2.05],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, -0.822987],
                           [0.4476394334178013, -0.16643814749969674, -0.822987],
                           [0.0, 0.0, 0.0]],
                          [[0.9733366782714342, 0.0, 0.0],
                           [0.0, 0.0, 9.721993326179174e-17],
                           [6.998170403949316e-17, 1.5372537772284038e-32, 2.05],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.7938610000000001],
                           [0.0, 0.0, 0.0],
                           [0.46299598437146455, -0.19801868253924385, 0.7938610000000001]]],
                         [[[1.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.0, 0.0, 0.0],
                           [-1.0, -2.5105259382520737e-16, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.0, 0.0, 0.0],
                           [0.0, 2.05, 0.0],
                           [-6.123233995736766e-17, 2.05, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[0.9999999999999998, 0.0, 0.0],
                           [0.0, 2.841180574021859e-16, 3.4794426957755093e-32],
                           [0.0, 2.841180574021859e-16, 0.0],
                           [1.0, 2.841180574021859e-16, -2.841180574021859e-16],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.0, 0.0, 0.0],
                           [0.0, -2.3199999999999994, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [-6.123233995736766e-17, 2.32, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.0, 0.0, 0.0],
                           [-1.0, -2.5105259382520737e-16, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [-0.3255680580517977, -0.9450769999999998, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.0, 0.0, 0.0],
                           [-1.0, -2.5105259382520737e-16, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [-0.3486703913933672, -0.9367336271288653, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.0, 0.0, 0.0],
                           [-1.0, -2.5105259382520737e-16, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [-0.39340606418230983, -0.9188902700377233, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.158739512195122, 0.0, 0.0],
                           [0.0, 2.05, -1.157385522997783e-16],
                           [-6.123233995736766e-17, 2.05, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [-7.783161089959995e-17, -3.794329301032237e-17, -0.9450769999999998],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0]],
                          [[1.7185320707150025, 0.0, 0.0],
                           [0.0, 2.05, 5.479008547045302e-17],
                           [-6.123233995736767e-17, 2.05, 5.942355766484037e-17],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.447395],
                           [0.8234366374014372, -0.3061644222584809, 0.447395],
                           [0.0, 0.0, 0.0]],
                          [[1.7591832011741875, 0.0, 0.0],
                           [0.0, 2.05, 5.667138788330315e-17],
                           [-6.123233995736762e-17, 2.05, 6.14639575192135e-17],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.0],
                           [0.0, 0.0, 0.4627569999999998],
                           [0.0, 0.0, 0.0],
                           [-0.7942709783949574, 0.3397016346360764, 0.4627569999999998]]]]
                    )

    assert np.allclose(zm2.get_grad_cartesian(as_function=False), expected2)
